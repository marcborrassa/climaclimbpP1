<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<title>Exercici</title>
<style>
  #map {
    height: 600px;
    width: 600px;
  }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

<h1>This is a heading</h1>
<p id="principal">This is a page</p>

Codi postal:<input type="text" id="text_cp">
<br/>
Num. resultats:<input type="text" id="text_resultats">
<br/>
<input type="button" value="Buscar" id="the_button">

<table id="taula-cps">
    <thead>
    <tr>
        <th>Codi Postal</th>
        <th>Ciutat</th>
        <th>Lat</th>
        <th>Lon</th>
        <th>Botó</th>
    </tr>
    </thead>
    <tbody id="dades-taula">
    <tr>
        <td>cp prova</td>
        <td>ciutat prova</td>
        <td>Lat prova</td>
        <td>Lon prova</td>
        <td>Botó</td>
    </tr>
    </tbody>
</table>

<br />
<br />

<div id="map"></div>


<script>
    var map = L.map("map", {center: [41.286117, 1.249929], zoom: 14});



      L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {attribution: '&copy; <a href="http://' +
          'www.openstreetmap.org/copyright">OpenStreetMap</a>'}
      ).addTo(map);

    function pintar_latitud (latitud, longitud){
        console.log(latitud, longitud);
        map.panTo([latitud, longitud],18);
    }

    function posar_pin(latitud, longitud){
        L.marker([latitud, longitud]).addTo(map)
        .bindPopup('A pretty CSS3 popup.<br> Easily customizable.')
        .openPopup();
    }
</script>

<script>
    document
    .getElementById("the_button")
    .addEventListener("click", () => {

    var cp=document.getElementById("text_cp").value;

    var nresultats=document.getElementById("text_resultats").value;

    var url = 'http://api.geonames.org/postalCodeSearchJSON?postalcode_startsWith='+cp+'&country=ES&maxRows='+nresultats+'&username=marcborrassa'

    console.log(url);

    fetch(url)
    .then(resposta => resposta.json())
    .then(json => {

        html=""
        json.postalCodes.forEach(function(element){

            html+= "<tr>";
            html+= "    <td>"+element.postalCode+"</td>";
            html+= "    <td>"+element.placeName+"</td>";
            html+= "    <td>"+element.lat+"</td>";
            html+= "    <td>"+element.lng+"</td>";
            html+= '    <td><input type="button" value="buscar lat" onClick="pintar_latitud('+element.lat+','+element.lng+');"></td>';
            html+= "</tr>";

            posar_pin (element.lat, element.lng)
        });

        console.log(html);

            document
            .getElementById("dades-taula")
            .innerHTML = html;

     })

    .catch(error => console.log(error));

    });
</script>

</body>
</html>
